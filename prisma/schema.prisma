generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  TOURIST
  GUIDE
  ADMIN
}

model User {
  id              String        @id @default(cuid())
  name            String
  email           String        @unique
  password        String
  role            UserRole      @default(TOURIST)
  isApproved      Boolean       @default(true)
  isEmailVerified Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  profile         UserProfile?
  guideProfile    GuideProfile?
  listings        Listing[]
  bookingsAsTourist Booking[]   @relation("TouristBookings")
  bookingsAsGuide Booking[]     @relation("GuideBookings")
  reviews         Review[]
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  bio         String?
  avatarUrl   String?
  languages   String[] @default([])
  city        String?
  country     String?
  preferences String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GuideProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  expertise          String[] @default([])
  dailyRate          Float?
  experienceYears    Int?
  verificationStatus String   @default("PENDING")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ListingStatus {
  DRAFT
  ACTIVE
  INACTIVE
  BLOCKED
}

enum ListingCategory {
  FOOD
  ART
  ADVENTURE
  CULTURE
  PHOTOGRAPHY
  NIGHTLIFE
  NATURE
  ARCHITECTURE
  SHOPPING
  FAMILY
  SPORTS
  HISTORY
}

model Listing {
  id           String          @id @default(cuid())
  guideId      String
  title        String
  description  String
  itinerary    String?
  city         String
  country      String
  category     ListingCategory
  languages    String[]        @default([])
  tourFee      Float // Per person or per group
  feeType      String          @default("PER_PERSON") // PER_PERSON or PER_GROUP
  duration     Int // Duration in hours
  meetingPoint String?
  meetingLat   Float?
  meetingLng   Float?
  maxGroupSize Int
  status       ListingStatus   @default(DRAFT)
  avgRating    Float           @default(0)
  totalReviews Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  deletedAt    DateTime?

  guide    User           @relation(fields: [guideId], references: [id], onDelete: Cascade)
  images   ListingImage[]
  bookings Booking[]
  reviews  Review[]

  @@index([guideId])
  @@index([city])
  @@index([country])
  @@index([category])
  @@index([status])
}

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  url       String
  order     Int      @default(0) // For ordering images
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

enum BookingStatus {
  PENDING
  ACCEPTED
  DECLINED
  PAID
  COMPLETED
  CANCELLED
}

model Booking {
  id          String        @id @default(cuid())
  listingId   String
  touristId   String
  guideId     String
  date        DateTime
  groupSize   Int
  totalPrice  Float
  platformFee Float         @default(0)
  note        String?
  status      BookingStatus  @default(PENDING)
  cancelledAt DateTime?
  cancelReason String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tourist User    @relation("TouristBookings", fields: [touristId], references: [id], onDelete: Cascade)
  guide   User    @relation("GuideBookings", fields: [guideId], references: [id], onDelete: Cascade)
  payment Payment?
  review  Review?

  @@index([listingId])
  @@index([touristId])
  @@index([guideId])
  @@index([status])
  @@index([date])
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

model Payment {
  id                    String        @id @default(cuid())
  bookingId             String        @unique
  amount                Float
  currency              String        @default("USD")
  status                PaymentStatus @default(PENDING)
  stripeCheckoutSessionId String?
  stripePaymentIntentId String?
  stripeCustomerId      String?
  stripePaymentId       String?
  paidAt                DateTime?
  refundedAt            DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
}

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  listingId String
  touristId String
  rating    Int      // 1-5
  title     String?
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tourist User    @relation(fields: [touristId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([listingId])
  @@index([touristId])
}
